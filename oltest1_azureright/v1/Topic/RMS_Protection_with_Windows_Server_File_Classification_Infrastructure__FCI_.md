---
description: na
keywords: na
title: RMS Protection with Windows Server File Classification Infrastructure (FCI)
search: na
ms.date: na
ms.service: rights-management
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 9aa693db-9727-4284-9f64-867681e114c9
---
# Использование защиты RMS совместно с инфраструктурой классификации файлов (FCI) Windows Server
В этой статье вы найдете инструкции и скрипт для настройки диспетчера ресурсов файлового сервера и инфраструктуры классификации файлов (FCI) с помощью клиента Rights Management (RMS) со средством защиты RMS.

Это решение позволит автоматически защитить все файлы в папке на файловом сервере под управлением Windows Server или автоматически защитить файлы, которые удовлетворяют определенным условиям. К таким файлам могут относиться файлы, содержащие конфиденциальные или важные данные. Это решение использует [Azure Rights Management](../Topic/Azure_Rights_Management.md) (Azure RMS) для защиты файлов, поэтому эта технология должна быть развернута в вашей организации.

> [!NOTE]
> Несмотря на то что Azure RMS включает [соединитель](https://technet.microsoft.com/library/dn375964.aspx), который поддерживает инфраструктуру классификации файлов, это решение поддерживает только встроенную защиту — например защиту для файлов Office.
> 
> Для поддержки всех типов файлов в инфраструктуре классификации файлов необходимо использовать модуль **Защита RMS** Windows PowerShell, как описано в этой статье. Командлеты защиты RMS, такие как приложение RMS-доступа, поддерживают универсальную защиту, а также встроенную защиту. Это означает, что можно защитить все файлы. Дополнительные сведения о различных уровнях защиты см. в разделе [Уровни защиты — собственный и универсальный](../Topic/Rights_Management_sharing_application_administrator_guide.md#BKMK_LevelsofProtection) статьи [Руководство администратора по приложению управления доступом Rights Management](../Topic/Rights_Management_sharing_application_administrator_guide.md).

Следующие инструкции относятся к Windows Server 2012 R2 или Windows Server 2012. Если вы используете другие поддерживаемые версии Windows, может потребоваться изменить некоторые шаги для учета различий между версиями вашей операционной системы и операционной системы, используемой в этой статье.

## Предварительные требования для использования защиты Azure RMS совместно с инфраструктурой классификации файлов Windows Server
Для выполнения этих инструкций необходимо обеспечить исполнение следующих предварительных требований.

-   На каждом файловом сервере, на котором будет запущен диспетчер ресурсов файлового сервера с инфраструктурой классификации файлов:

    -   диспетчер ресурсов файлового сервера должен быть установлен как одна из служб роли для роли файловых служб;

    -   должна быть определена локальная папка, содержащая файлы для защиты с использованием Rights Management, например C:\FileShare;

    -   вы установили средство защиты RMS, включая необходимые компоненты для средства (например, клиент RMS) и для Azure RMS (например, учетную запись субъекта-службы). Дополнительные сведения см. в статье [Командлеты защиты RMS](https://msdn.microsoft.com/library/azure/mt433195.aspx).

    -   Если вы хотите изменить уровень защиты RMS по умолчанию (встроенный или универсальный) для определенных расширений имен файлов, необходимо внести изменения в реестр, как описано на странице [Настройка API файлов](https://msdn.microsoft.com/library/dn197834%28v=vs.85%29.aspx).

    -   У вас должно быть настроено подключение к Интернету, при необходимости с заданными параметрами прокси-сервера. Например: `netsh winhttp import proxy source=ie`

-   Вы настроили дополнительные необходимые компоненты, требующиеся для развертывания Azure Rights Management, как описано в статье [about_RMSProtection_AzureRMS](https://msdn.microsoft.com/library/mt433202.aspx). В частности, вы используете следующие параметры для подключения к Azure RMS с помощью субъекта-службы:

    -   BposTenantId

    -   AppPrincipalId

    -   Симметричный ключ

-   Вы синхронизировали локальные учетные записи пользователей Active Directory с Azure Active Directory или Office 365, включая адреса электронной почты. Это требуется для всех пользователей, которым может потребоваться доступ к файлам после того, как они будут защищены FCI и Azure RMS. Если не выполнить этот шаг (например, в тестовой среде), пользователям может быть заблокирован доступ к этим файлам. Если вам нужна дополнительная информация об этой конфигурации учетных записей, см. статью [Подготовка к установке службы Azure Rights Management](../Topic/Preparing_for_Azure_Rights_Management.md).

-   Вы определили шаблон, с помощью которого Rights Management будет защищать файлы. Если необходимо, установите идентификатор этого шаблона с помощью командлета [Get-RMSTemplate](https://msdn.microsoft.com/library/azure/mt433197.aspx).

## Инструкции по настройке FCI диспетчера ресурсов файлового сервера для работы с защитой Azure RMS
Выполните эти инструкции для автоматической защиты всех файлов в папке с помощью скрипта Windows PowerShell в качестве пользовательской задачи. Выполните эти действия в указанном порядке.

1.  Сохраните скрипт Windows PowerShell.

2.  Создайте свойство классификации для Rights Management (RMS).

3.  Создайте правило классификации (классификация для RMS).

4.  Настройте расписание классификации.

5.  Создайте пользовательскую задачу управления файлами (защита файлов с RMS).

6.  Проверьте конфигурацию, запустив правило и задачу вручную.

После выполнения этих инструкций все файлы в выбранной папке будут классифицированы с помощью пользовательского свойства RMS и защищены Rights Management. Для более сложной конфигурации, при которой выборочно защищаются одни файлы и не защищаются другие, можно будет создать другие свойство и правило классификации и задачу управления файлами, которая защищает только эти файлы.

#### Сохранение скрипта Windows PowerShell

1.  Разверните раздел [Скрипт Windows PowerShell для использования защиты Azure RMS совместно с инфраструктурой классификации файлов диспетчера ресурсов файлового сервера](#BKMK_RMSProtection_Script) этой статьи и скопируйте его содержимое. Вставьте содержимое скрипта и назовите файл **RMS-Protect-FCI.ps1** на локальном компьютере.

2.  Просмотрите скрипт и внесите следующие изменения.

    -   Найдите следующую строку и замените ее собственным AppPrincipalId, который используется с командлетом [Set-RMSServerAuthentication](https://msdn.microsoft.com/library/mt433199.aspx) для подключения к Azure RMS:

        ```
        <enter your AppPrincipalId here>
        ```
        Скрипт может выглядеть так:

        `[Parameter(Mandatory = $false)]`

        `[Parameter(Mandatory = $false)] [string]$AppPrincipalId = "b5e3f76a-b5c2-4c96-a594-a0807f65bba4",`

    -   Найдите следующую строку и замените ее собственным симметричным ключом, который используется с командлетом [Set-RMSServerAuthentication](https://msdn.microsoft.com/library/mt433199.aspx) для подключения к Azure RMS:

        ```
        <enter your key here>
        ```
        Скрипт может выглядеть так:

        `[Parameter(Mandatory = $false)]`

        `[string]$SymmetricKey = "zIeMu8zNJ6U377CLtppkhkbl4gjodmYSXUVwAO5ycgA="`

    -   Найдите следующую строку и замените ее собственным BposTenantId (идентификатором клиента), который используется с командлетом [Set-RMSServerAuthentication](https://msdn.microsoft.com/library/mt433199.aspx) для подключения к Azure RMS:

        ```
        <enter your BposTenantId here>
        ```
        Скрипт может выглядеть так:

        `[Parameter(Mandatory = $false)]`

        `[string]$BposTenantId = "23976bc6-dcd4-4173-9d96-dad1f48efd42",`

    -   Если сервер работает под управлением Windows Server 2012, может потребоваться вручную загрузить модуль защиты RMS в начале скрипта. Добавьте следующую команду (или аналогичную команду, если каталог Program Files находится не на диске C:):

        ```
        Import-Module "C:\Program Files\WindowsPowerShell\Modules\RMSProtection\RMSProtection.dll"
        ```

3.  Подпишите скрипт. Если вы не подписываете скрипт (более безопасный вариант), необходимо настроить Windows PowerShell на серверах, на которых он запускается. Например, запустите сеанс Windows PowerShell с помощью пункта меню **Запуск от имени администратора**, а затем введите следующее: **Set-ExecutionPolicy Unrestricted**. Но учтите, что эта конфигурация позволяет запускать все неподписанные скрипты (что снижает уровень безопасности).

    Дополнительные сведения о подписывании скриптов Windows PowerShell см. в статье [about_Signing](https://technet.microsoft.com/library/hh847874.aspx) библиотеки документации по PowerShell.

4.  Сохраните файл локально на каждом файловом сервере, на котором будет запущен диспетчер ресурсов файлового сервера с инфраструктурой классификации файлов. Например, сохраните файл в **C:\RMS-Protection**. Защитите этот файл с помощью разрешений NTFS, чтобы неавторизованные пользователи не могли его изменить.

Теперь вы готовы приступить к настройке диспетчера ресурсов файлового сервера.

#### Создание свойства классификации для Rights Management (RMS)

-   В диспетчере ресурсов файлового сервера выберите «Управление классификацией» и создайте новое локальное свойство.

    -   **Имя**. Введите **RMS**.

    -   **Описание**.   Введите **Защита Rights Management**.

    -   **Тип свойства**: выберите **Да/Нет**.

    -   **Значение**: выберите **Да**.

Теперь можно создать правило классификации, которое использует это свойство.

#### Создание правила классификации (классификация для RMS)

-   Создайте новое правило классификации.

    -   На вкладке **Общие**

        -   **Имя**. Введите **Классификация для RMS**.

        -   **Включено**. Оставьте значение по умолчанию — флажок установлен.

        -   **Описание**. Введите **Классифицировать все файлы из папки &lt;имя_папки&gt; для Rights Management**.

            Замените *&lt;имя_папки&gt;* на имя выбранной папки. Например, **Классифицировать все файлы из папки C:\FileShare для Rights Management**.

        -   **Область действия**: добавьте выбранную папку. Например, **C:\FileShare**.

            Не устанавливайте флажки.

    -   На вкладке **Классификация**:

    -   **Метод классификации**: выберите **Классификатор папок**.

    -   Имя **свойства**: выберите **RMS**.

    -   **Значение** свойства: выберите **Да**.

Хотя правила классификации и можно запускать вручную для текущих операций, это правило должно запускаться по расписанию, чтобы новые файлы классифицировались с использованием свойства RMS.

#### Настройка расписания классификации

-   На вкладке **Автоматическая классификация**:

    -   **Включить фиксированное расписание**: установите этот флажок.

    -   Настройте расписание для запуска всех правил классификации, которые включают наше новое правило для классификации файлов с использованием свойства RMS.

    -   **Разрешить постоянную классификацию новых файлов**: установите этот флажок для классификации новых файлов.

    -   Необязательно. Внесите другие необходимые изменения, например настройте параметры для отчетов и уведомлений.

Теперь вы закончили настройку классификации и готовы к настройке задачи управления для применения защиты RMS к файлам.

#### Создание пользовательской задачи управления файлами (защита файлов с RMS)

-   В разделе **Задачи управления файлами** создайте новую задачу управления файлами.

    -   На вкладке **Общие**

        -   **Имя задачи**: введите **Защита файлов с RMS**.

        -   Оставьте флажок **Включено** установленным.

        -   **Описание**. Введите **Защита файлов для папки &lt;имя_папки&gt; с помощью Rights Management и шаблона с использованием скрипта Windows PowerShell.**

            Замените *&lt;имя_папки&gt;* на имя выбранной папки. Например, **Защита файлов для папки C:\FileShare с помощью Rights Management и шаблона с использованием скрипта Windows PowerShell.**

        -   **Область действия**: укажите выбранную папку. Например, **C:\FileShare**.

            Не устанавливайте флажки.

    -   На вкладке **Действие**:

        -   **Тип**. выберите **Пользовательское**.

        -   **Исполняемый файл**: укажите следующее:

            ```
            C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
            ```
            Если Windows находится не на диске C:, измените этот путь или выберите файл.

        -   **Аргумент**: укажите следующее, подставив собственные значения для параметров &lt;path&gt; (путь) и &lt;template ID&gt; (идентификатор шаблона):

            ```
            -Noprofile -Command "<path>\RMS-Protect-FCI.ps1 -File '[Source File Path]' -TemplateID <template GUID> -OwnerMail [Source File Owner Email]"
            ```
            Например, если вы скопировали скрипт в C:\RMS-Protection, а идентификатор шаблона, определенный на предварительном этапе, — e6ee2481-26b9-45e5-b34a-f744eacd53b0, укажите следующее:

            `-Noprofile -Command "C:\RMS-Protection\RMS-Protect-FCI.ps1 -File '[Source File Path]' -TemplateID e6ee2481-26b9-45e5-b34a-f744eacd53b0 -OwnerMail [Source File Owner Email]"`

            В этой команде **[Source File Path]** (Путь к исходному файлу) и **[Source File Owner Email]** (Адрес электронной почты владельца исходного файла) используются инфраструктурой классификации файлов, поэтому введите их именно так, как они указаны в команде выше. Первый параметр используется инфраструктурой классификации файлов для автоматического указания конкретного файла в папке, а второй — для автоматического получения адреса электронной почты владельца указанного файла. Эта команда повторяется для каждого файла в папке, в данном примере — для каждого файла в папке C:\FileShare, у которого есть дополнительное свойство классификации файлов RMS.

            > [!NOTE]
            > Параметр и значение  **-OwnerMail [Source File Owner Email]** гарантируют, что исходный владелец файла получит права владения на файл, защищенный Rights Management, после его защиты. Это гарантирует, что исходный владелец файла получит все права Rights Management на собственные файлы. Если файлы создаются пользователем домена, адрес электронной почты автоматически извлекается из Active Directory с помощью имени учетной записи пользователя в свойстве "Владелец" файла. Для этого файловый сервер должен находиться в том же домене, что и пользователь, или в доверенном домене.
            > 
            > По возможности сохраняйте исходных владельцев защищенных документов, чтобы эти пользователи по-прежнему имели полный контроль над файлами, которые они создали. Однако при использовании переменной [Source File Owner Email] (Адрес электронной почты владельца исходного файла), как показано выше, если пользователь домена не является владельцем файла (например, для создания файла использовалась локальная учетная запись, потому владелец отображается как SYSTEM), скрипт завершится с ошибкой.
            > 
            > Для файлов, владельцем которых не является пользователь домена, можно скопировать и сохранить эти файлы самостоятельно от имени пользователя домена, чтобы стать владельцем только этих файлов. Или, если у вас есть разрешения, вы можете вручную изменить владельца.  Или же можно указать вместо переменной [Source File Owner Email] (Адрес электронной почты владельца исходного файла) конкретный адрес электронной почты (например, собственный или групповой адрес отдела ИТ). При этом все файлы, которые будут защищены с помощью этого скрипта, будут использовать этот адрес электронной почты для определения нового владельца.

    -   **Выберите способ выполнения команды**: выберите **Локальная система**.

    -   На вкладке **Условие**:

        -   **Свойство**: выберите **RMS**.

        -   **Оператор**: выберите **Равно**.

        -   **Значение**: выберите **Да**.

    -   На вкладке **Расписание**:

        -   **Запустить в**: настройте предпочтительное расписание.

            Отведите достаточно времени для завершения скрипта. Хотя это решение и защищает все файлы в папке, скрипт выполняется каждый раз для каждого файла. Несмотря на то что это занимает больше времени, чем одновременная защита всех файлов, которую поддерживает средство защиты RMS, эта пофайловая конфигурация инфраструктуры классификации файлов обладает более широкими возможностями. Например, при использовании переменной [Source File Owner Email] (Адрес электронной почты владельца исходного файла) защищенные файлы могут иметь разных владельцев (с сохранением первоначального владельца), и эта пофайловая операция потребуется, если впоследствии вы захотите изменить конфигурацию для выборочной защиты файлов, а не всех файлов в папке.

        -   **Выполнять непрерывно для новых файлов**: установите этот флажок.

#### Проверка конфигурации путем запуска правила и задачи вручную

1.  Запуск правила классификации

    1.  Щелкните **Правила классификации** &gt; **Запустить классификацию со всеми правилами**.

    2.  Щелкните **Подождать завершения классификации**, а затем нажмите кнопку **ОК**.

2.  Дождитесь закрытия диалогового окна **Запуск классификации**, а затем просмотрите результаты в отчете, который откроется автоматически. Вы должны увидеть **1** для поля **Свойства** и число файлов в папке. Убедитесь в наличии файлов в выбранной папке и проверьте их свойства с помощью проводника. На вкладке **Классификация** вы должны увидеть **RMS** в качестве имени свойства и **Да** в качестве **значения** свойства.

3.  Запуск задачи управления файлами

    1.  Щелкните **Задачи управления файлами** &gt; **Защита файлов с помощью RMS** &gt; **Запустить задачу управления файлами**.

    2.  Щелкните **Дождаться завершения задачи**, а затем нажмите кнопку **ОК**.

4.  Дождитесь закрытия диалогового окна **Запуск задачи управления файлами**, а затем просмотрите результаты в отчете, который откроется автоматически. Вы увидите число файлов, которые находятся в выбранной папке, в поле **Файлы**. Убедитесь, что файлы в выбранной папке теперь защищены RMS. Например, если выбрана папка C:\FileShare, введите следующую команду в сеансе Windows PowerShell и убедитесь, что файлы не имеют состояние **UnProtected** (Не защищены):

    ```
    foreach ($file in (Get-ChildItem -Path C:\FileShare -Force | where {!$_.PSIsContainer})) {Get-RMSFileStatus -f $file.PSPath}
    ```
    > [!TIP]
    > Некоторые советы по устранению проблем
    > 
    > -   Если вы видите в отчете **0** вместо числа файлов в папке, это означает, что скрипт не был выполнен. Сначала проверьте сам скрипт, загрузив его в Windows PowerShell ISE. Проверьте содержимое скрипта и запустите его, чтобы увидеть, возникают ли ошибки при его запуске. Если запустить скрипт без аргументов, он попытается подключиться к Azure RMS и выполнить проверку подлинности.
    > 
    >     -   Если скрипт сообщает, что не удалось подключиться к Azure RMS, проверьте отображаемые значения для учетной записи субъекта-службы, указанной в скрипте.  Дополнительные сведения о создании этой учетной записи субъекта-службы см. в описании второго предварительного действия в статье [about_RMSProtection_AzureRMS](https://msdn.microsoft.com/library/mt433202.aspx).
    >     -   Если скрипт сообщает, что он может подключиться к Azure RMS и ваш регион Azure находится за пределами Северной Америки, проверьте, что вы правильно изменили реестр для этой конфигурации. Это удобно проверить, запустив Get-RMSTemplate непосредственно из Windows PowerShell на сервере. Дополнительные сведения об изменении реестра см. в описании третьего предварительного действия в статье [about_RMSProtection_AzureRMS](https://msdn.microsoft.com/library/mt433202.aspx).
    > -   Если сам скрипт запускается в Windows PowerShell ISE без ошибок, запустите его следующим образом из сеанса PowerShell, указав имя файла для защиты и без параметра -OwnerEmail:
    > 
    >     ```
    >     powershell.exe -Noprofile -Command "<path>\RMS-Protect-FCI.ps1 -File <full path and name of a file>' -TemplateID <template GUID>"
    >     ```
    >     -   Если скрипт успешно запускается в этом сеансе Windows PowerShell, проверьте значения параметров **Исполняемый файл** и **Аргумент** в действии задачи управления файлами.  Если вы указали **-OwnerEmail [Source File Owner Email]**, попробуйте удалить этот параметр.
    > 
    >         Если задача управления файлами успешно работает без  **-OwnerEmail [Source File Owner Email]**, убедитесь, что в незащищенных файлах в качестве владельца файлов указан пользователь домена, а не **SYSTEM**.  Для этого откройте вкладку **Безопасность** в свойствах файла и щелкните **Дополнительно**. Значение **Владелец** отобразится сразу после **имени** файла. Кроме того, убедитесь, что файловый сервер находится в том же домене или в доверенном домене для поиска адреса электронной почты пользователя из доменных служб Active Directory.
    > -   Если в отчете отображается правильное число файлов, но файлы не защищены, попробуйте защитить файлы вручную с помощью командлета [Protect-RMSFile](https://msdn.microsoft.com/library/azure/mt433201.aspx), чтобы проверить, возникают ли ошибки.

После подтверждения того, что эти задачи успешно выполнены, вы можете закрыть диспетчер файловых ресурсов. Новые файлы будут автоматически защищены, и все файлы будут защищены повторно при выполнении расписаний. Повторная защита файлов гарантирует, что все изменения в шаблоне применяются к файлам.

### <a name="BKMK_RMSProtection_Script"></a>Скрипт Windows PowerShell для использования защиты Azure RMS совместно с инфраструктурой классификации файлов диспетчера ресурсов файлового сервера
Этот раздел содержит пример скрипта для копирования и изменения, как описано в предыдущем разделе.

*&#42;&#42;Отказ от ответственности&#42;&#42; Данный пример скрипта не поддерживается никакой из стандартных программ или служб поддержки корпорации Майкрософт. Этот пример скрипта предоставляется «как есть» без каких-либо гарантий.*

```
<# .SYNOPSIS Helper script to protect all file types with Azure RMS and FCI. .DESCRIPTION Protect files with Azure RMS and Windows Server FCI, using an RMS template ID. #> param( [Parameter(Mandatory = $false)] [ValidateScript({ If($_ -eq "") {$true} else { if (Test-Path -Path $_ -PathType Leaf) {$true} else {throw "Can't find file specified"} } })] [string]$File, [Parameter(Mandatory = $false)] [string]$TemplateID, [Parameter(Mandatory = $false)] [string]$OwnerMail, [Parameter(Mandatory = $false)] [string]$AppPrincipalId = "<enter your AppPrincipalId here>", [Parameter(Mandatory = $false)] [string]$SymmetricKey = "<enter your key here>", [Parameter(Mandatory = $false)] [string]$BposTenantId = "<enter your BposTenantId here>" ) # script information [String] $Script:Version = 'version 1.0' [String] $Script:Name = "RMS-Protect-FCI.ps1" #global working variables [switch] $Script:isScriptProcess = $False # Controls the script process. If false, the script gracefully stops running. #**Functions (general helper)*************************************** function Get-ScriptName(){ return $MyInvocation.ScriptName.Substring($MyInvocation.ScriptName.LastIndexOf('\') + 1, $MyInvocation.ScriptName.LastIndexOf('.') - $MyInvocation.ScriptName.LastIndexOf('\') - 1) } #**Functions (script specific)************************************** function Check-Module{ param ([String]$Module = $(Throw "Module name not specified")) [bool]$isResult = $False #try to load the module if (get-module -list -name $Module) { import-module $Module if (get-module -name $Module ) { $isResult = $True } else { $isResult = $False } } else { $isResult = $False } return $isResult } function Protect-File ($ffile, $ftemplateId, $fownermail) { [bool] $returnValue = $false try { If ($OwnerMail -eq $null -or $OwnerMail -eq "") { $protectReturn = Protect-RMSFile -File $ffile -TemplateID $ftemplateId $returnValue = $true Write-Host ( "Information: " + "Protected File: $ffile with Template: $ftemplateId") } else { $protectReturn = Protect-RMSFile -File $ffile -TemplateID $ftemplateId -OwnerEmail $fownermail $returnValue = $true Write-Host ( "Information: " + "Protected File: $ffile with Template: $ftemplateId, set Owner: $fownermail") } } catch { Write-Host ( "ERROR" + "During protection of file: $ffile with Template: $ftemplateId") } return $returnValue } function Set-RMSConnection ($fappId, $fkey, $fbposId) { [bool] $returnValue = $false try { Set-RMSServerAuthentication -AppPrincipalId $fappId -Key $fkey -BposTenantId $fbposId Write-Host ("Information: " + "Connected to Azure RMS Service with BposTenantId: $fbposId using AppPrincipalId: $fappId") $returnValue = $true } catch { Write-Host ("ERROR" + "During connection to Azure RMS Service with BposTenantId: $fbposId using AppPrincipalId: $fappId") } return $returnValue } #**Main Script (Script)********************************************* Write-Host ("-== " + $Script:Name + " " + $Version + " ==-") $Script:isScriptProcess = $True # Validate Azure RMS connection by checking the module and then connection if ($Script:isScriptProcess) { if (Check-Module -Module RMSProtection){ $Script:isScriptProcess = $True } else { Write-Host ("The RMSProtection module is not loaded") -foregroundcolor "yellow" -backgroundcolor "black" $Script:isScriptProcess = $False } } if ($Script:isScriptProcess) { #Write-Host ("Try to connect to Azure RMS with AppId: $AppPrincipalId and BPOSID: $BposTenantId" ) if (Set-RMSConnection $AppPrincipalId $SymmetricKey $BposTenantId) { Write-Host ("Connected to Azure RMS") } else { Write-Host ("Couldn't connect to Azure RMS") -foregroundcolor "yellow" -backgroundcolor "black" $Script:isScriptProcess = $False } } #  Start working loop if ($Script:isScriptProcess) { if ( !(($File -eq $null) -or ($File -eq "")) ) { if (!(Protect-File -ffile $File -ftemplateId $TemplateID -fownermail $OwnerMail)) { $Script:isScriptProcess = $False } } } # Closing if (!$Script:isScriptProcess) { Write-Host "ERROR occurred during script process" -foregroundcolor "red" -backgroundcolor "black"} write-host ("-== " + $Script:Name + " " + $Version + "  ==-") if (!$Script:isScriptProcess) { exit(-1) } else {exit(0)}
```

## Изменение инструкций для выборочной защиты файлов
Если предыдущие инструкции работают, их легко изменить для реализации более сложной конфигурации. Например, защитите файлы, используя тот же скрипт, но только те файлы, которые содержат персональные данные, и, возможно, воспользуйтесь шаблоном, который имеет более ограниченные права.

Для этого используйте встроенные свойства классификации (например, **Личные сведения**) или создайте новое свойство. Затем создайте новое правило, который использует это свойство. Например, можно выбрать **Классификатор содержимого**, выбрать свойство **Личные сведения** со значением **Высокое**, и настроить строку или шаблон выражения, который определяет файл для настройки с помощью этого свойства (например, строка «**Дата рождения**»).

Теперь достаточно создать новые задачи управления файлами, которые используют тот же скрипт, но, возможно, с другим шаблоном, и настроить условие для свойства классификации, которое вы только что настроили. Например, вместо условия, которое было настроено ранее (свойство **RMS**, **Равно**, **Да**), выберите свойство **Личные сведения** со значением **Оператор**, установленным в значение **Равно**, и со **значением**, равным **Высокое**.

