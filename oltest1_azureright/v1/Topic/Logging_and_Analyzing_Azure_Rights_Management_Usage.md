---
description: na
keywords: na
title: Logging and Analyzing Azure Rights Management Usage
search: na
ms.date: na
ms.service: rights-management
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: a735f3f7-6eb2-4901-9084-8c3cd3a9087e
---
# Ведение журнала и анализ использования Azure Rights Management
Этот раздел поможет понять, как использовать ведение журналов с Azure Rights Management (Azure RMS). Служба Azure Rights Management может регистрировать каждый запрос, сделанный для организации, включая запросы от пользователей, действия, выполняемые администраторами Rights Management в организации, и действия, выполняемые операторами Майкрософт для поддержки развертывания Azure Rights Management.

Затем вы можете использовать эти журналы Azure Rights Management для поддержки следующих бизнес-сценариев.

-   Анализ бизнес-информации.

    Azure Rights Management записывает журналы в расширенном формате журнала W3C в предоставленную учетную запись хранения Azure. Затем можно направить эти журналы в выбранный репозиторий (такой, как база данных, система OLAP или система map-reduce) для анализа информации и создания отчетов. Например, можно установить, кто получает доступ к данным, защищенным RMS. Можно определить, к каким именно защищаемым RMS данным имеют доступ пользователи, с каких устройств и откуда. Можно выяснить, могут ли пользователи успешно читать защищенное содержимое. Можно также установить, какие пользователи прочли важный защищенный документ.

-   Отслеживание нарушений.

    Сведения журналов Azure Rights Management доступны практически в режиме реального времени, так что вы можете непрерывно отслеживать использование Rights Management в организации. 99,9% журналов становятся доступными в течение 15 минут после действия, запускающего RMS.

    Например, можно получать оповещение, если происходит резкое увеличение количества пользователей, читающих защищенные RMS данные вне стандартного рабочего времени, что может указывать на сбор злоумышленником информации для продажи конкурентам. Также, если один и тот же пользователь получает доступ к данным с разных IP-адресов в течение короткого времени, это может указывать на взлом учетной записи пользователя.

-   Выполнение криминалистического анализа.

    Если происходит утечка информации, то скорее всего потребуются сведения о том, кто недавно использовал конкретные документы, и к какой информации имело доступ подозреваемое лицо в последнее время. На такие вопросы вы можете ответить при использовании Azure Rights Management и ведении журналов, поскольку пользователи, использующие защищенный контент, всегда должны получать лицензию Rights Management для открытия защищенных Rights Management документов и фотографий, даже если эти файлы отправляются по электронной почте или копируются на USB-накопитель или на другие устройства хранения. Это означает, что вы можете использовать журналы Azure Rights Management в качестве основного источника информации для криминалистического анализа при защите данных с помощью Azure Rights Management.

> [!NOTE]
> Если вас интересуют только журналы административных задач для Azure Rights Management и использование Rights Management отслеживать не требуется, вы можете воспользоваться командлетом [Get-AadrmAdminLog](https://msdn.microsoft.com/library/azure/dn629430.aspx) Windows PowerShell для Azure Rights Management.
> 
> Кроме того, с помощью классического портала Azure вы можете получить высокоуровневые отчеты об использовании, содержащие данные об **использовании RMS**, **самых активных пользователях RMS**, **использовании устройств с RMS** и **использовании приложений с включенной службой RMS**. Для доступа к этим отчетам с помощью классического портала Azure щелкните **Active Directory**, выберите и откройте каталог и нажмите кнопку **ОТЧЕТЫ**.

Дополнительные сведения о ведении журналов Azure Rights Management см. в следующих разделах.

-   [Включение ведения журнала использования Azure Rights Management](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_EnableRMSLogging)

-   [Получение доступа к журналам использования Azure Rights Management и их использование](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_AccesAndUseLogs)

-   [Управление хранилищем журналов Azure Rights Management](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_ManageStorage)

-   [Делегирование доступа к журналам использования Azure Rights Management](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_Delegate)

-   [Интерпретация журналов использования Azure Rights Management](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_Interpret)

-   [Справочник по Windows PowerShell](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_PowerShell)

## <a name="BKMK_EnableRMSLogging"></a>Включение ведения журнала использования Azure Rights Management
Ведение журнала использования Azure Rights Management не обязательно, поэтому, если планируется его использовать, необходимо выполнить определенные действия. Ведение журнала использования Azure Rights Management не влияет на работу Rights Management, и сам процесс ведения журнала бесплатный. Однако необходимо предоставить для журналов учетную запись хранения Azure, и за это хранилище будет взиматься плата.

Перед началом работы необходимо убедиться, что выполнены следующие обязательные требования для ведения журналов использования Azure Rights Management.

|Требование|Дополнительные сведения|
|--------------|---------------------------|
|ИТ-управляемая подписка, которая включает Azure Rights Management|Необходимо иметь подписку Microsoft Azure Rights Management, которой управляет ваша организация. Организации, использующие RMS для отдельных пользователей, не могут использовать ведение журналов использования Azure Rights Management.<br /><br />Если в организации есть сотрудники, использующие RMS для отдельных пользователей, ведение журналов использования Azure Rights Management является очень веской причиной для перехода от RMS для отдельных пользователей к подписке Microsoft Azure Rights Management.<br /><br />Дополнительные сведения о подписках, включающих Azure RMS, см. в разделе [Поддерживающая Azure RMS облачная подписка](../Topic/Requirements_for_Azure_Rights_Management.md#BKMK_SupportedSubscriptions) статьи [Требования для службы Azure Rights Management](../Topic/Requirements_for_Azure_Rights_Management.md).<br /><br />Дополнительные сведения о службе RMS для частных лиц см. в разделе [RMS для отдельных пользователей и служба Azure Rights Management](../Topic/RMS_for_Individuals_and_Azure_Rights_Management.md)|
|Подписка Azure|Необходимо иметь подписку Azure и достаточный объем хранилища в Azure для журналов Azure Rights Management.|
|Windows PowerShell для Azure Rights Management|Загрузите и установите модуль Windows PowerShell для Azure Rights Management, если вы еще этого не сделали. Для настройки журналов использования Azure Rights Management и управления ими вы можете воспользоваться командлетами Windows PowerShell.<br /><br />Дополнительные сведения см. в [Установка Windows PowerShell для Azure Rights Management](../Topic/Installing_Windows_PowerShell_for_Azure_Rights_Management.md).|
Для включения ведения журналов использования Azure Rights Management используется следующая процедура, которая включает действия по созданию учетной записи хранения Azure и последующую настройку Azure для использования этой учетной записи хранения для журналов Rights Management.

> [!NOTE]
> В этой процедуре предполагается, что имеется учетная запись Azure. Ведение журналов использования Azure Rights Management поддерживает индивидуальные учетные записи, но рекомендуется использовать учетные записи организации или учебного заведения. Кроме того, рекомендуется создать выделенную учетную запись хранения для журналов Rights Management. Ключи доступа к хранилищу необходимо предоставить Azure Rights Management и, возможно, другим пользователям, если они также будут использовать файлы журналов.
> 
> Дополнительные сведения о хранилище Azure см. в [документации по хранилищу Azure](http://azure.microsoft.com/documentation/services/storage/).

#### Создание учетной записи хранения и включение ведения журналов использования Azure Rights Management

1.  Войдите на [портал Azure](https://portal.azure.com/).

2.  В меню «Концентратор» выберите **Создать** -&gt; **Данные + хранилище** -&gt; **Учетная запись хранения**.

    > [!TIP]
    > Если этот параметр не отображается, убедитесь, что имеется подписка Azure в дополнение к подписке для Rights Management.

3.  В качестве модели развертывания по умолчанию оставьте **Классическую** и нажмите кнопку **Создать**.

    Укажите имя вашей учетной записи хранения и при необходимости измените значения параметров **Ценовая категория**, **Группа ресурсов**, **Подписка** и **Прикрепить к панели мониторинга**. Затем нажмите кнопку **СОЗДАТЬ**. Подождите, пока действие **Создание учетной записи хранения** будет завершено.

4.  Щелкните созданную учетную запись хранения и затем щелкните **Параметры**.

5.  В колонке **Параметры** щелкните значок **Ключи**.

6.  В колонке **Управление ключами** скопируйте значение параметра **ПЕРВИЧНЫЙ КЛЮЧ ДОСТУПА** и закройте колонку.

7.  Запустите Windows PowerShell с параметром **Запуск от имени администратора**. Запустите команду [Connect-AadrmService](https://msdn.microsoft.com/library/azure/dn629415.aspx), чтобы подключиться к службе Azure Rights Management:

    ```
    Connect-AadrmService
    ```

8.  С помощью команды [Set-AadrmUsageLogStorageAccount](https://msdn.microsoft.com/library/azure/dn629426.aspx) укажите, где должны сохраняться журналы использования Azure Rights Management, заменив *&lt;ключ_доступа&gt;* значением первичного ключа доступа, скопированным на шаге 6, а *&lt;учетную_запись_хранения&gt;* — именем учетной записи хранения, созданной на шаге 3:

    ```
    $accesskey = convertto-securestring -asplaintext -force –string <Access_Key> Set-AadrmUsageLogStorageAccount -AccessKey $accesskey -StorageAccount <StorageAccount>
    ```

9. С помощью команды [Enable-AadrmUsageLogFeature](https://msdn.microsoft.com/library/azure/dn629421.aspx) включите ведение журналов использования Azure Rights Management:

    ```
    Enable-AadrmUsageLogFeature
    ```
    Должно появиться следующее сообщение: **Ведение журнала использования включено для службы Rights Management.**

Теперь, когда ведение журналов использования включено, Azure Rights Management начинает регистрировать все действия в организации и сохраняет эти сведения в вашей учетной записи хранения. До этого момента сведения журналов недоступны.

Дополнительные сведения о создании учетных записей хранения см. в статьях [Создание учетной записи хранения](https://azure.microsoft.com/documentation/articles/storage-create-storage-account/) и [Об учетных записях хранения Azure](https://azure.microsoft.com/documentation/articles/storage-create-storage-account/) в документации Azure.

## <a name="BKMK_AccesAndUseLogs"></a>Получение доступа к журналам использования Azure Rights Management и их использование
Azure Rights Management записывает журналы в учетную запись хранения Azure в виде последовательности больших двоичных объектов. Каждый BLOB-объект содержит от одной до нескольких записей журнала в расширенном формате журнала W3C. В качестве имен BLOB-объектов используются числа, показывающие порядок их создания. Дополнительные сведения о содержимом журналов и их создании см. в разделе [Интерпретация журналов использования Azure Rights Management](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_Interpret) ниже в этом документе.

После включения ведения журналов использования Azure Rights Management может пройти некоторое время, прежде чем журналы появятся в учетной записи хранения. Большинство журналов появляется в течение 15 минут.

Учетная запись хранения, созданная для журналов использования Azure Rights Management, представляет собой некий аналог почтового ящика и поддерживает чтение непосредственно из этой учетной записи, но не оптимизирована для такого использования. Для улучшения производительности и сокращения затрат рекомендуется загружать журналы в локальное хранилище, такое как локальная папка, база данных или репозиторий map-reduce.

Вы можете загрузить журналы использования двумя способами.

-   Воспользоваться командлетом Windows PowerShell [Get-AadrmUsageLog](https://msdn.microsoft.com/library/azure/dn629401.aspx).

    Это простейший способ доступа к журналам использования. Этот командлет загружает журналы на компьютер, причем каждый BLOB-объект загружается как файл в указанное расположение.

-   Используйте [пакет SDK хранилища Azure](http://www.windowsazure.com/en-us/develop/net/) для создания вашего собственного приложения для загрузки журналов.

    Пользовательское приложение может предоставить большую гибкость, чем командлет Get-AadrmUsageLog. Например, вы можете делегировать загрузку журналов пользователю или процессу, который не должен использовать учетные данные администратора Azure Rights Management. Можно также опрашивать журналы в режиме реального времени, чтобы отслеживать неправильное использование.

#### Загрузка журналов использования с помощью PowerShell

-   Запустите Windows PowerShell, выбрав **Запуск от имени администратора**, и выполните **Get-AadrmUsageLog –Path &lt;location&gt;**. Например, после создания папки с именем **logs** на диске E:

    -   Чтобы скачать все доступные журналы в папку E:\logs: `Get-AadrmUsageLog -Path "e:\logs"`

    -   Чтобы скачать определенный диапазон BLOB-объектов: `Get-AadrmUsageLog –Path "e:\logs" –FromCounter 1024 –ToCounter 2047`

При выполнении этих командлетов Windows PowerShell отображает имя последнего загруженного BLOB-объекта. Можно назначить этот имя переменной, что позволит выполнять Get-AadrmUsageLog в цикле или как запланированное задание, каждый раз загружая только добавочные журналы.

Например:

**PS C:\&gt; $LastBlobName = Get-AadrmUsageLog –Path "e:\logs"**

**1527**

**PS C:\&gt; $LastBlobName**

**1527**

> [!TIP]
> Можно собрать все загруженные файлы журналов в формате CSV с помощью средства анализа журналов [Log Parser компании Майкрософт](http://www.microsoft.com/download/details.aspx?id=24659), которое представляет собой инструмент для преобразования различных распространенных форматов журналов. Кроме того, этот инструмент можно также использовать для преобразования данных в формат SYSLOG или для импорта их в базу данных. После установки этого инструмента выполните команду **LogParser.exe /?**, чтобы получить справку и сведения о его использовании. Например, для импорта всей информации в файл формата LOG можно выполнить следующую команду: **logparser –i:w3c –o:csv “SELECT &#42; INTO AllLogs.csv FROM &#42;.log”**.

Вы можете приостанавливать и возобновлять ведение журналов использования. При приостановке ведения журналов использования Azure Rights Management сохраняет сведения об учетной записи хранения, поэтому ведение журналов можно легко возобновить.

#### Приостановка и возобновление ведения журналов использования

-   Для приостановки ведения журналов используется следующий командлет: [Disable-AadrmUsageLogFeature](https://msdn.microsoft.com/library/azure/dn629404.aspx)

-   Для возобновления ведения журналов используется следующий командлет: [Enable-AadrmUsageLogFeature](https://msdn.microsoft.com/library/azure/dn629421.aspx)

-   Чтобы проверить, включено ведение журналов или отключено, используется следующий командлет: [Get-AadrmUsageLogFeature](https://msdn.microsoft.com/library/azure/dn629425.aspx)

    Значение **True** означает, что ведение журналов использования для Azure Rights Management включено, а **False** — отключено.

## <a name="BKMK_ManageStorage"></a>Управление хранилищем журналов Azure Rights Management
За пространство хранилища, используемое для хранения журналов Azure Rights Management, взимается плата.

Azure Rights Management не выполняет автоматического управления файлами журналов использования. Если не предпринимать никакие действия, то журналы будут оставаться в учетной записи хранения. Однако может потребоваться удалить журналы после их загрузки, чтобы сохранить пространство и сократить затраты на хранение. Можно также выбрать файлы для удаления. Azure Rights Management не использует эти файлы журналов, поэтому вы можете их удалять в любое время, с одним исключением.

Файл с именем **metadata**, находящийся в контейнере **rms-metadata**, нельзя удалять или изменять. Azure Rights Management использует этот большой двоичный объект для отслеживания номера последнего использованного большого двоичного объекта. Если удалить этот файл, Azure Rights Management создаст новый контейнер для журналов с нумерацией больших двоичных объектов, начиная с 1, и этот контейнер будет использован для всех последующих загрузок файлов журналов с помощью командлета Get-AadrmUsageLog. В результате все журналы в исходном контейнере сохраняются, но оказываются потерянными. Загрузить их можно будет только с помощью пакета SDK службы хранилища Azure.

> [!TIP]
> Вместо самостоятельного управления хранилищем журналов Azure Rights Management вы можете делегировать функцию управления другой компании, предоставив имя учетной записи хранения и ключ доступа. Дополнительные сведения см. в следующем разделе данной статьи: [Делегирование доступа к журналам использования Azure Rights Management](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_Delegate).

В некоторых случаях может потребоваться заново создать ключи доступа к хранилищу. Например:

-   Вы изменяете компанию, управляющую журналами использования Azure Rights Management.

-   есть основания подозревать, что ключи доступа к хранилищу скомпрометированы.

Если возникают такие обстоятельства, то в это время можно начать использовать вторичный ключ доступа (если предположить, что до этого использовался первичный ключ доступа), чтобы обеспечить непрерывность обслуживания. После повторного создания ключа доступа, который ранее не применялся, необходимо настроить использование этого нового ключа в Azure Rights Management. Чтобы заново создать вторичный ключ доступа и настроить Azure Rights Management для его использования, воспользуйтесь следующей процедурой.

#### Повторное создание вторичного ключа доступа

1.  Войдите на [портал Azure](https://portal.azure.com/).

2.  Щелкните **Все ресурсы** и найдите свое хранилище, введя имя хранилища в текстовом поле.

3.  Выберите свое хранилище и щелкните **Параметры**.

4.  Щелкните значок **Ключи**.

5.  В разделе **Управление ключами** щелкните **Повторно создать вторичный ключ**, щелкните «Да», чтобы подтвердить создание ключа, и скопируйте новый вторичный ключ в буфер обмена.

    Не закрывайте портал Azure.

6.  Запустите Windows PowerShell с помощью пункта меню **Запуск от имени администратора** и с помощью командлета [Set-AadrmUsageLogStorageAccount](https://msdn.microsoft.com/library/azure/dn629426.aspx) настройте использование нового ключа доступа в Azure Rights Management, заменив *&lt;StorageAccount&gt;* на имя учетной записи хранения и *&lt;Access_Key&gt;* — на заново созданный вторичный ключ доступа, который был скопирован в буфер:

    ```
    Set-AadrmUsageLogStorageAccount -StorageAccount <StorageAccount>-AccessKey <Access_Key>
    ```
    > [!WARNING]
    > Хотя при выполнении этой команды вы можете переключиться на другую учетную запись хранения, в результате такого действия предыдущие журналы будут потеряны и больше не будут доступны командлету Set-AadrmUsageLogStorageAccount и другим аналогичным командам и функциям управления.

7.  В разделе **Управление ключами** портала Azure выполните повторное создание первичного ключа доступа.

Дополнительные сведения об управлении учетными записями хранения см. в статьях [Управление ключами доступа к хранилищу](https://azure.microsoft.com/documentation/articles/storage-create-storage-account/) и [Об учетных записях хранения Azure](https://azure.microsoft.com/documentation/articles/storage-create-storage-account/) в документации Azure.

## <a name="BKMK_Delegate"></a>Делегирование доступа к журналам использования Azure Rights Management
Чтобы делегировать доступ к журналам RMS, можно сообщить имя учетной записи хранения и ключ доступа. Может потребоваться делегировать доступ другому администратору, разработчику в текущей организации или независимому поставщику программного обеспечения. Поскольку у них не будет учетных данных администратора RMS, они не смогут использовать командлет Get-AardrmUsageLog для загрузки журналов RMS. Для загрузки журналов им придется использовать пакет SDK службы хранилища Windows. Кроме того, они могут написать приложение для чтения журналов непосредственно из службы хранилища Azure.

Сообщать имя учетной записи хранения и ключ доступа совершенно безопасно, если эта учетная запись хранения является выделенной для журналов RMS. Даже при наличии ключа доступа другие люди не смогут использовать его для доступа к любым другим учетным записям хранения или воспользоваться вашей учетной записью клиента RMS.

## <a name="BKMK_Interpret"></a>Интерпретация журналов использования Azure Rights Management
Следующие сведения помогут в интерпретации журналов использования Azure Rights Management.

### Структура учетной записи хранения
При первой записи журналов в учетную запись хранения Azure Rights Management создает два следующих контейнера:

-   **Rms-metadata**: Этот контейнер зарезервирован для Azure Rights Management. Не изменяйте и не удаляйте его.

-   **Rms-logs-&lt;guid&gt;**: В этом контейнере Azure Rights Management создает и сохраняет журналы. Любые файлы в этом контейнере можно безопасно удалять, если содержащиеся в них сведения становятся не нужны.

Со временем Azure Rights Management может создавать дополнительные контейнеры **Rms-logs-&lt;guid&gt;**. Например, если контейнер **Rms-metadata** поврежден или случайно удален, Azure Rights Management сбрасывает его содержимое и создает новый контейнер **Rms-logs-&lt;guid&gt;** для всех будущих журналов. Старые журналы в старом контейнере не удаляются, но становятся потерянными.

### Последовательность журналов
Azure Rights Management записывает журналы как последовательность больших двоичных объектов. Каждый BLOB-объект содержит от одной до нескольких записей журнала в расширенном формате журнала W3C.

В качестве имени каждого BLOB-объекта используется число. В каждом контейнере журналов первый BLOB-объект имеет имя 000000001. Каждый BLOB-объект именуется последовательно в порядке создания. Каждый BLOB-объект содержит от одной до нескольких записей журнала. В каждой записи журнала имеется метка времени в формате UTC, указывающая, когда соответствующий запрос был обработан Azure Rights Management.

> [!IMPORTANT]
> Система ведения журналов Azure Rights Management оптимизирована для быстрого предоставления журналов, а не для предоставления их в строгом последовательном порядке. Порядок BLOB-объектов, как и порядок записей журнала в них, может выходить за рамки хронологической последовательности. BLOB-объекты получают последовательные имена только для того, чтобы можно было эффективно выполнять их добавочную загрузку.
> 
> Далее приводятся два примера возможных результатов последовательности журналов.
> 
> -   Записи журнала в BLOB-объекте 000000004 могут хронологически перекрывать записи журнала в BLOB-объекте 000000003. В исключительных случаях все записи журнала в BLOB-объекте 000000004 могут быть созданы до всех записей журнала в BLOB-объекте 000000003.
> -   Вторая запись журнала в BLOB-объекте может быть создана до первой записи, но записана в хранилище в обратном порядке.

Перед анализом журналов использования Azure Rights Management рекомендуется загрузить и импортировать журнал в репозиторий, где вы можете упорядочивать журналы по их меткам времени. Дополнительные сведения о загрузке журналов см. в разделе [Получение доступа к журналам использования Azure Rights Management и их использование](../Topic/Logging_and_Analyzing_Azure_Rights_Management_Usage.md#BKMK_AccesAndUseLogs) этой статьи.

Поскольку журналы не обязательно соблюдают хронологический порядок и при этом большинство из них записывается в течение 15 минут после запроса, при идентификации нужных журналов по их метке времени добавьте 15 минут ко времени, которое вас интересует. Затем загрузите эти журналы. Такая стратегия должна обеспечить получение почти всех журналов.

Кроме того, необходимо учитывать, что метка времени в каждой записи журнала представляет локальное время службы Azure Rights Management, которая обработала запрос. Поскольку Azure Rights Management работает на множестве серверов в множестве центров обработки данных, журналы могут выглядеть непоследовательными, даже если они были упорядочены по меткам времени. Однако разница невелика и обычно не превышает одной минуты. В большинстве случаев это не представляет проблему для анализа журналов.

### Формат BLOB-объекта
Каждый BLOB-объект находится в расширенном формате журналов W3C. Он начинается со следующих двух строк.

**#Software: RMS**

**#Version: 1.1**

Первая строка определяет, что это журнал Azure Rights Management. Вторая строка указывает, что остальная часть большого двоичного объекта соответствует версии 1.1 спецификации. Рекомендуется, чтобы любые приложения, выполняющие анализ этих журналов, проверяли эти две строки, прежде чем анализировать остальную часть BLOB-объекта.

В третьей строке перечисляются имена полей, разделенные табуляциями:

**#Fields: date            time            row-id        request-type           user-id       result          correlation-id          content-id                owner-email           issuer                     template-id             file-name                  date-published      c-info         c-ip**

Все следующие строки являются записями журнала. Значения полей находятся в том же порядке, как указано в третьей строке, и разделяются табуляциями. Для интерпретации этих полей используйте следующую таблицу.

|Имя поля|Тип данных W3C|Описание|Пример значения|
|------------|------------------|------------|-------------------|
|date|Дата|Дата обслуживания запроса в формате UTC.<br /><br />Источник — локальные часы сервера, обслужившего запрос.|2013-06-25|
|time|Время|Время UTC в 24-часовом формате, когда запрос был обработан.<br /><br />Источник — локальные часы сервера, обслужившего запрос.|21:59:28|
|row-id|text|Уникальный GUID для этой записи журнала.<br /><br />Это значение удобно использовать при объединении журналов или копировании журналов в другой формат.|1c3fe7a9-d9e0-4654-97b7-14fafa72ea63|
|request-type|Название|Имя запрошенного API RMS.|AcquireLicense|
|user-id|Строка|Пользователь, отправивший запрос.<br /><br />Значение заключается в одинарные кавычки. Некоторые типы запросов являются анонимными, в этом случае значение будет ''.|'joe@contoso.com'|
|result|Строка|Значение 'Success', если запрос был обработан успешно.<br /><br />Тип ошибки в одинарных кавычках, если запрос завершился неудачно.|'Success'|
|correlation-id|text|GUID, который для данного запроса является общим в клиентском и серверном журналах RMS.<br /><br />Это значение может быть полезно при устранении проблем клиента.|cab52088-8925-4371-be34-4b71a3112356|
|content-id|text|GUID, заключенный в фигурные скобки, который идентифицирует защищенный контент (например, документ).<br /><br />Это поле имеет значение только в том случае, если request-type имеет значение AcquireLicense; для всех остальных типов запросов это поле пустое.|{bb4af47b-cfed-4719-831d-71b98191a4f2}|
|owner-email|Строка|Адрес электронной почты владельца документа.|alice@contoso.com|
|issuer|Строка|Адрес электронной почты эмитента документа.|alice@contoso.com (или) FederatedEmail.4c1f4d-93bf-00a95fa1e042@contoso.onmicrosoft.com'|
|Template-id|Строка|Идентификатор шаблона, используемый для защиты документа.|{6d9371a6-4e2d-4e97-9a38-202233fed26e}|
|File-name|Строка|Имя файла документа, который был защищен.|TopSecretDocument.docx|
|Date-published|Дата|Дата, когда документ был защищен.|2015-10-15T21:37:00|
|c-info|Строка|Сведения о клиентской платформе, с которой был выполнен запрос.<br /><br />Конкретная строка зависит от приложения (например, от операционной системы или браузера).|'MSIPC;version=1.0.623.47;AppName=WINWORD.EXE;AppVersion=15.0.4753.1000;AppArch=x86;OSName=Windows;OSVersion=6.1.7601;OSArch=amd64'|
|c-ip|Адрес|IP-адрес клиента, из которого был сделан запрос.|64.51.202.144|

#### Исключения для поля user-id
Хотя поле user-id обычно указывает пользователя, сделавшего запрос, имеется два исключения, когда значение этого поля не соответствует реальному пользователю.

-   Значение **'microsoftrmsonline@&lt;ИД_клиента&gt;.rms.&lt;регион&gt;.aadrm.com'**.

    Это значение указывает службу Office 365, такую как Exchange Online или Sharepoint Online, сделавшую запрос. В этой строке *&lt;ИД_клиента&gt;* представляет GUID клиента, а *&lt;регион&gt;* — регион, в котором зарегистрирован клиент. Например **na** представляет Северную Америку, **eu** представляет Европу, а **ap** представляет Азию.

-   При использовании соединителя RMS.

    Запросы от этого соединителя регистрируются с именем участника-службы, которое RMS автоматически создает при установке соединителя RMS.

#### Распространенные типы запросов
В Azure Rights Management существует много типов запросов, но в следующей таблице приведены самые распространенные из них.

|Тип запроса|Описание|
|---------------|------------|
|AcquireLicense|Клиент с компьютера под управлением Windows запрашивает лицензию для содержимого, защищенного с помощью RMS.|
|AcquirePreLicense|Клиент от имени пользователя запрашивает лицензию для содержимого, защищенного с помощью RMS.|
|AcquireTemplates|Был выполнен вызов для получения шаблонов по идентификаторам шаблонов.|
|AcquireTemplateInformation|Был выполнен вызов для получения идентификаторов шаблона от службы.|
|AddTemplate|Выполняется вызов для добавления шаблона из классического портала Azure.|
|BECreateEndUserLicenseV1|Выполняется вызов для создания лицензии конечного пользователя с мобильного устройства.|
|BEGetAllTemplatesV1|Выполняется вызов для получения всех шаблонов (внутренних) с мобильного устройства.|
|Certify|Клиент удостоверяет содержимое для защиты.|
|Decrypt|Клиент пытается расшифровать защищенное RMS-содержимое.|
|DeleteTemplateById|Выполняется вызов для удаления шаблона из классического портала Azure по идентификатору шаблона.|
|ExportTemplateById|Выполняется вызов для экспорта шаблона из классического портала Azure по идентификатору шаблона.|
|FECreateEndUserLicenseV1|Аналогичен типу запроса AcquireLicense, но для мобильных устройств.|
|FECreatePublishingLicenseV1|Этот тип аналогичен объединению типов Certify и GetClientLicensorCert, но для мобильных клиентов.|
|FEGetAllTemplates|Выполняется вызов для получения шаблонов (клиентских) с мобильного устройства.|
|GetAllTemplates|Выполняется вызов для получения всех шаблонов из классического портала Azure.|
|GetClientLicensorCert|Клиент запрашивает сертификат издателя (который впоследствии будет использоваться для защиты контента) от компьютера с ОС Windows.|
|GetConfiguration|Вызывается командлет Azure PowerShell для получения конфигурации клиента Azure RMS.|
|GetConnectorAuthorizations|Выполняется вызов из соединителей RMS для получения их конфигурации из облака.|
|GetTenantFunctionalState|Классический портал Azure проверяет, активирована ли Azure RMS.|
|GetTemplateById|Выполняется вызов для получения шаблона из классического портала Azure по идентификатору шаблона.|
|ExportTemplateById|Выполняется вызов для экспорта шаблона из классического портала Azure по идентификатору шаблона.|
|FindServiceLocationsForUser|Выполняется вызов для запроса URL-адресов, который используется для вызова Certify или AcquireLicense.|
|ImportTemplate|Выполняется вызов для импорта шаблона из классического портала Azure.|
|ServerCertify|Выполняется вызов для удостоверения сервера из клиента с поддержкой RMS (например, SharePoint).|
|SetUsageLogFeatureState|Выполняется вызов для включения ведения журналов использования.|
|SetUsageLogStorageAccount|Выполняется вызов для указания местоположения журналов Azure RMS.|
|SignDigest|Выполняется вызов при использовании ключа с целью подписи. Этот вызов обычно выполняется один раз для AcquireLicence (или FECreateEndUserLicenseV1), Certify и GetClientLicensorCert (или FECreatePublishingLicenseV1).|
|UpdateTemplate|Выполняется вызов для обновления существующего шаблона из классического портала Azure.|

## <a name="BKMK_PowerShell"></a>Справочник по Windows PowerShell
Следующие командлеты Windows PowerShell помогут настроить и использовать ведение журналов Azure Rights Management:

-   [Disable-AadrmUsageLogFeature](https://msdn.microsoft.com/library/azure/dn629404.aspx)

-   [Enable-AadrmUsageLogFeature](https://msdn.microsoft.com/library/azure/dn629421.aspx)

-   [Get-AadrmUsageLog](https://msdn.microsoft.com/library/azure/dn629401.aspx)

-   [Get-AadrmUsageLogFeature](https://msdn.microsoft.com/library/azure/dn629425.aspx)

-   [Get-AadrmUsageLogLastCounterValue](https://msdn.microsoft.com/library/azure/dn629423.aspx)

-   [Get-AadrmUsageLogStorageAccount](https://msdn.microsoft.com/library/azure/dn629419.aspx)

-   [Set-AadrmUsageLogStorageAccount](https://msdn.microsoft.com/library/azure/dn629426.aspx)

Дополнительные сведения о Windows PowerShell для Azure Rights Management см. в разделе [Администрирование Azure Rights Management с помощью Windows PowerShell](../Topic/Administering_Azure_Rights_Management_by_Using_Windows_PowerShell.md).

## См. также
[Использование службы Azure Rights Management](../Topic/Using_Azure_Rights_Management.md)

